import numpy as np
from scipy.signal import butter, filtfilt, iirnotch
import pywt
from EMD.sift import sift   # âœ… force emd-signal (faster + stable)


# ------------------------
# Empirical Mode Decomposition (EMD)
# ------------------------
def apply_emd(signal):
    """Apply Empirical Mode Decomposition using emd-signal."""
    imfs = sift(signal)
    return imfs


# ------------------------
# Bandpass filter
# ------------------------
def butter_bandpass(lowcut=0.5, highcut=50.0, fs=500, order=4):
    nyq = 0.5 * fs
    low, high = lowcut / nyq, highcut / nyq
    b, a = butter(order, [low, high], btype="band")
    return b, a


def bandpass_filter(signal, lowcut=0.5, highcut=50.0, fs=500, order=4):
    b, a = butter_bandpass(lowcut, highcut, fs, order)
    return filtfilt(b, a, signal)


# ------------------------
# Notch filter (50/60Hz powerline)
# ------------------------
def notch_filter(signal, freq=50.0, fs=500, quality=30):
    b, a = iirnotch(w0=freq / (fs / 2), Q=quality)
    return filtfilt(b, a, signal)


# ------------------------
# Wavelet Denoising
# ------------------------
def wavelet_denoise(signal, wavelet="db4", level=1):
    coeffs = pywt.wavedec(signal, wavelet, level=level)
    sigma = np.median(np.abs(coeffs[-level])) / 0.6745
    uthresh = sigma * np.sqrt(2 * np.log(len(signal)))
    coeffs[1:] = (pywt.threshold(i, value=uthresh, mode="soft") for i in coeffs[1:])
    return pywt.waverec(coeffs, wavelet)


# ------------------------
# Normalization
# ------------------------
def normalize(signal):
    signal = np.array(signal)
    return (signal - np.mean(signal)) / (np.std(signal) + 1e-8)


# ------------------------
# Main Preprocessing Pipeline
# ------------------------
def preprocess_ecg(signal, fs=500):
    # Step 1: Bandpass
    filtered = bandpass_filter(signal, fs=fs)

    # Step 2: Notch filter
    filtered = notch_filter(filtered, fs=fs)

    # Step 3: Wavelet denoising
    denoised = wavelet_denoise(filtered)

    # Step 4: Normalization
    normalized = normalize(denoised)

    # Step 5: EMD decomposition
    imfs = apply_emd(normalized)

    return {
        "filtered_signal": normalized,
        "imfs": imfs
    }
